# CI/CD Setup

**Date**: 2026-01-24
**Status**: Draft

## Overview

Set up a complete CI/CD pipeline for ntnsync, including automated testing, linting, releases, Docker images, documentation website, and PR automation (auto-merge and auto-update). This follows patterns from [dbbat](https://github.com/fclairamb/dbbat) but adapted for a CLI-only Go project without frontend.

## Components

### 1. GitHub Actions Workflows

#### `.github/workflows/ci.yml` - Continuous Integration

Runs on every push and PR to main.

```yaml
name: CI

on:
  push:
    branches: [main]
    paths-ignore:
      - "website/**"
      - ".github/workflows/website.yml"
  pull_request:
    branches: [main]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2

      - uses: actions/setup-go@v6.2.0
        with:
          go-version: "1.25"

      - uses: golangci/golangci-lint-action@v9.2.0
        with:
          version: v2.8

  test:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2

      - uses: actions/setup-go@v6.2.0
        with:
          go-version: "1.25"

      - name: Run tests
        run: go test -race -coverprofile=coverage.out ./...

      - name: Upload coverage
        uses: codecov/codecov-action@v5.5.2
        with:
          files: coverage.out
        continue-on-error: true

  build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0

      - uses: actions/setup-go@v6.2.0
        with:
          go-version: "1.25"

      - name: Build binary
        run: |
          VERSION=${GITHUB_REF_NAME:-dev}
          COMMIT=${GITHUB_SHA::7}
          GIT_TIME=$(TZ=UTC git log -1 --format=%cd --date=format-local:%Y-%m-%dT%H:%M:%SZ)
          go build -ldflags "-X 'github.com/fclairamb/ntnsync/internal/version.Version=$VERSION' \
                            -X 'github.com/fclairamb/ntnsync/internal/version.Commit=$COMMIT' \
                            -X 'github.com/fclairamb/ntnsync/internal/version.GitTime=$GIT_TIME'" \
            -o ./bin/ntnsync .

      - name: Upload binary
        uses: actions/upload-artifact@v6.0.0
        with:
          name: ntnsync-binary
          path: bin/ntnsync
          retention-days: 1
```

#### `.github/workflows/release-please.yml` - Automated Release PRs

Creates release PRs based on conventional commits.

```yaml
name: Release Please

on:
  push:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-24.04
    steps:
      - uses: googleapis/release-please-action@v4.4.0
        with:
          token: ${{ secrets.CI_PAT }}
```

#### `.github/workflows/release.yml` - Release Builds

Builds and publishes on tag push.

```yaml
name: Release

on:
  push:
    tags:
      - "v*"
    branches:
      - "release-test/v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to release (e.g., v0.0.1)"
        required: true
        type: string

permissions:
  contents: write
  packages: write

jobs:
  release:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2
        with:
          fetch-depth: 0

      - name: Checkout tag for workflow_dispatch
        if: github.event_name == 'workflow_dispatch'
        run: git checkout ${{ inputs.tag }}

      - name: Determine release mode
        id: mode
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            TAG="${{ inputs.tag }}"
            echo "is_test=false" >> $GITHUB_OUTPUT
            echo "version=${TAG#v}" >> $GITHUB_OUTPUT
            echo "docker_tags<<EOF" >> $GITHUB_OUTPUT
            echo "ghcr.io/fclairamb/ntnsync:${TAG#v}" >> $GITHUB_OUTPUT
            echo "ghcr.io/fclairamb/ntnsync:latest" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          elif [[ "${{ github.ref_type }}" == "tag" ]]; then
            echo "is_test=false" >> $GITHUB_OUTPUT
            echo "version=${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
            echo "docker_tags<<EOF" >> $GITHUB_OUTPUT
            echo "ghcr.io/fclairamb/ntnsync:${GITHUB_REF_NAME#v}" >> $GITHUB_OUTPUT
            echo "ghcr.io/fclairamb/ntnsync:latest" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          else
            VERSION="${GITHUB_REF_NAME#release-test/v}"
            echo "is_test=true" >> $GITHUB_OUTPUT
            echo "version=${VERSION}" >> $GITHUB_OUTPUT
            echo "docker_tags=ghcr.io/fclairamb/ntnsync:test-${VERSION}" >> $GITHUB_OUTPUT
          fi

      - uses: actions/setup-go@v6.2.0
        with:
          go-version: "1.25"

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3.7.0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3.12.0

      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3.6.0
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v6.4.0
        with:
          version: "~> v2"
          args: release --clean ${{ steps.mode.outputs.is_test == 'true' && '--snapshot' || '' }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Get git timestamp
        id: git
        run: echo "time=$(TZ=UTC git log -1 --format=%cd --date=format-local:%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_OUTPUT

      - name: Build and push container images
        uses: docker/build-push-action@v6.18.0
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.mode.outputs.docker_tags }}
          build-args: |
            VERSION=${{ steps.mode.outputs.version }}
            COMMIT=${{ github.sha }}
            GIT_TIME=${{ steps.git.outputs.time }}
          labels: |
            org.opencontainers.image.title=ntnsync
            org.opencontainers.image.description=Sync Notion pages to local markdown files
            org.opencontainers.image.version=${{ steps.mode.outputs.version }}
            org.opencontainers.image.source=${{ github.server_url }}/${{ github.repository }}
            org.opencontainers.image.revision=${{ github.sha }}
            org.opencontainers.image.created=${{ steps.git.outputs.time }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Release summary
        run: |
          echo "## Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.mode.outputs.is_test }}" == "true" ]]; then
            echo "ðŸ§ª **Mode:** Test Release" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- GoReleaser ran in snapshot mode (no GitHub release created)" >> $GITHUB_STEP_SUMMARY
            echo "- Docker image pushed to: \`ghcr.io/fclairamb/ntnsync:test-${{ steps.mode.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
          else
            echo "ðŸš€ **Mode:** Production Release" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- GitHub release created with binaries" >> $GITHUB_STEP_SUMMARY
            echo "- Docker images pushed to:" >> $GITHUB_STEP_SUMMARY
            echo "  - \`ghcr.io/fclairamb/ntnsync:${{ steps.mode.outputs.version }}\`" >> $GITHUB_STEP_SUMMARY
            echo "  - \`ghcr.io/fclairamb/ntnsync:latest\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ steps.mode.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
```

#### `.github/workflows/semantic-pr.yml` - PR Title Validation

Ensures PR titles follow conventional commit format.

```yaml
name: Lint PR

on:
  pull_request_target:
    types:
      - opened
      - reopened
      - edited

permissions:
  pull-requests: read

jobs:
  main:
    name: Validate PR title
    runs-on: ubuntu-24.04
    steps:
      - uses: amannn/action-semantic-pull-request@v6.1.1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          scopes: |
            cli
            notion
            sync
            store
            webhook
            deps
            docs
            ci
          requireScope: false
```

#### `.github/workflows/auto-merge.yml` - Auto-merge PRs

Enables auto-merge for PRs labeled with `automerge`.

```yaml
name: Auto-merge

on:
  pull_request:
    types: [labeled, opened, synchronize, reopened]

permissions:
  pull-requests: write
  contents: write

jobs:
  automerge:
    runs-on: ubuntu-24.04
    if: contains(github.event.pull_request.labels.*.name, 'automerge')
    steps:
      - name: Enable auto-merge
        run: gh pr merge --auto --squash "${{ github.event.pull_request.number }}"
        env:
          GH_TOKEN: ${{ secrets.CI_PAT }}
          GH_REPO: ${{ github.repository }}
```

#### `.github/workflows/auto-update.yml` - Auto-update PRs

Keeps PRs with `autoupdate` or `automerge` labels up-to-date with main.

```yaml
name: Auto-update PRs

on:
  push:
    branches: [main]

permissions:
  pull-requests: write

jobs:
  auto-update:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2

      - uses: castastrophe/actions-pr-auto-update@v2.0.1
        with:
          token: ${{ secrets.CI_PAT }}
          include_labels: autoupdate, automerge
          limit: 2
```

#### `.github/workflows/website.yml` - Documentation Website

Builds and deploys Docusaurus site to GitHub Pages.

```yaml
name: Website

on:
  push:
    branches: [main]
    paths:
      - "website/**"
      - ".github/workflows/website.yml"
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v6.0.2

      - uses: oven-sh/setup-bun@v2.1.2

      - name: Install dependencies
        run: bun install
        working-directory: website

      - name: Build website
        run: bun run build
        working-directory: website

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v4.0.0
        with:
          path: website/build

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-24.04
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4.0.5
```

### 2. GoReleaser Configuration

#### `.goreleaser.yml`

```yaml
version: 2

project_name: ntnsync

builds:
  - id: ntnsync
    main: .
    binary: ntnsync
    goos:
      - linux
      - darwin
      - windows
    goarch:
      - amd64
      - arm64
    ignore:
      - goos: windows
        goarch: arm64
    ldflags:
      - -s -w
      - -X 'github.com/fclairamb/ntnsync/internal/version.Version={{ .Version }}'
      - -X 'github.com/fclairamb/ntnsync/internal/version.Commit={{ .ShortCommit }}'
      - -X 'github.com/fclairamb/ntnsync/internal/version.GitTime={{ .CommitDate }}'
    env:
      - CGO_ENABLED=0

archives:
  - id: default
    formats:
      - tar.gz
    format_overrides:
      - goos: windows
        formats:
          - zip
    name_template: >-
      {{ .ProjectName }}_{{ .Version }}_{{ .Os }}_{{ .Arch }}
    files:
      - LICENSE*
      - README*

checksum:
  name_template: 'checksums.txt'
  algorithm: sha256

changelog:
  disable: true  # Changelog is generated by release-please

release:
  github:
    owner: fclairamb
    name: ntnsync
  draft: false
  prerelease: auto
  name_template: "v{{ .Version }}"
```

### 3. Release Please Configuration

#### `release-please-config.json`

```json
{
  "packages": {
    ".": {
      "release-type": "go",
      "changelog-path": "CHANGELOG.md",
      "bump-minor-pre-major": true,
      "bump-patch-for-minor-pre-major": true
    }
  }
}
```

#### `.release-please-manifest.json`

```json
{
  ".": "0.0.0"
}
```

### 4. Website (Docusaurus)

#### `website/package.json`

```json
{
  "name": "ntnsync-website",
  "version": "0.0.1",
  "private": true,
  "scripts": {
    "docusaurus": "docusaurus",
    "start": "docusaurus start",
    "build": "docusaurus build",
    "serve": "docusaurus serve",
    "clear": "docusaurus clear",
    "typecheck": "tsc"
  },
  "dependencies": {
    "@docusaurus/core": "3.9.2",
    "@docusaurus/preset-classic": "3.9.2",
    "@mdx-js/react": "^3.0.0",
    "clsx": "^2.0.0",
    "prism-react-renderer": "^2.3.0",
    "react": "^19.0.0",
    "react-dom": "^19.0.0"
  },
  "devDependencies": {
    "@docusaurus/module-type-aliases": "3.9.2",
    "@docusaurus/tsconfig": "3.9.2",
    "@docusaurus/types": "3.9.2",
    "typescript": "~5.9.0"
  },
  "browserslist": {
    "production": [">0.5%", "not dead", "not op_mini all"],
    "development": ["last 3 chrome version", "last 3 firefox version", "last 5 safari version"]
  },
  "engines": {
    "node": ">=20.0"
  },
  "packageManager": "bun@1.1.0"
}
```

#### `website/docusaurus.config.ts`

```typescript
import { themes as prismThemes } from "prism-react-renderer";
import type { Config } from "@docusaurus/types";
import type * as Preset from "@docusaurus/preset-classic";

const config: Config = {
  title: "ntnsync",
  tagline: "Sync Notion pages to local markdown files with git versioning",
  favicon: "img/favicon.ico",

  url: "https://fclairamb.github.io",
  baseUrl: "/ntnsync/",

  organizationName: "fclairamb",
  projectName: "ntnsync",
  trailingSlash: false,

  onBrokenLinks: "throw",
  onBrokenMarkdownLinks: "warn",

  future: {
    v4: true,
  },

  i18n: {
    defaultLocale: "en",
    locales: ["en"],
  },

  presets: [
    [
      "classic",
      {
        docs: {
          sidebarPath: "./sidebars.ts",
          editUrl: "https://github.com/fclairamb/ntnsync/tree/main/website/",
        },
        blog: false,
        theme: {
          customCss: "./src/css/custom.css",
        },
      } satisfies Preset.Options,
    ],
  ],

  themeConfig: {
    navbar: {
      title: "ntnsync",
      items: [
        {
          type: "docSidebar",
          sidebarId: "tutorialSidebar",
          position: "left",
          label: "Documentation",
        },
        {
          href: "https://github.com/fclairamb/ntnsync",
          label: "GitHub",
          position: "right",
        },
      ],
    },
    footer: {
      style: "dark",
      links: [
        {
          title: "Docs",
          items: [
            {
              label: "Getting Started",
              to: "/docs/intro",
            },
            {
              label: "CLI Commands",
              to: "/docs/cli-commands",
            },
          ],
        },
        {
          title: "Community",
          items: [
            {
              label: "GitHub Issues",
              href: "https://github.com/fclairamb/ntnsync/issues",
            },
          ],
        },
      ],
      copyright: `&copy; ntnsync ${new Date().getFullYear()}`,
    },
    prism: {
      theme: prismThemes.github,
      darkTheme: prismThemes.dracula,
      additionalLanguages: ["bash", "yaml", "json", "go", "markdown"],
    },
    colorMode: {
      defaultMode: "light",
      disableSwitch: false,
      respectPrefersColorScheme: true,
    },
  } satisfies Preset.ThemeConfig,
};

export default config;
```

#### Website Structure

```
website/
â”œâ”€â”€ docusaurus.config.ts
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ sidebars.ts
â”œâ”€â”€ static/
â”‚   â””â”€â”€ img/
â”‚       â””â”€â”€ favicon.ico
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â””â”€â”€ custom.css
â”‚   â””â”€â”€ pages/
â”‚       â””â”€â”€ index.tsx
â””â”€â”€ docs/
    â”œâ”€â”€ intro.md
    â”œâ”€â”€ cli-commands.md
    â”œâ”€â”€ configuration.md
    â””â”€â”€ ...
```

### 5. Renovate Configuration

#### `.github/renovate.json`

```json
{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended",
    ":semanticCommits"
  ],
  "labels": ["automerge"],
  "packageRules": [
    {
      "matchUpdateTypes": ["minor", "patch"],
      "matchCurrentVersion": "!/^0/",
      "automerge": true
    }
  ]
}
```

## Implementation Steps

### Phase 1: Core CI

1. Create `.github/workflows/ci.yml`
2. Create `.github/workflows/semantic-pr.yml`
3. Create `.github/workflows/auto-merge.yml`
4. Create `.github/workflows/auto-update.yml`
5. Add `.golangci.yml` if not present

### Phase 2: Release Pipeline

1. Create `.github/workflows/release-please.yml`
2. Create `release-please-config.json` and `.release-please-manifest.json`
3. Create `.goreleaser.yml`
4. Create `.github/workflows/release.yml`
5. Create `Dockerfile` (per existing spec)

### Phase 3: Website

1. Initialize Docusaurus in `website/` folder
2. Migrate existing `docs/` content to `website/docs/`
3. Create homepage
4. Create `.github/workflows/website.yml`
5. Enable GitHub Pages in repository settings

### Phase 4: Polish

1. Add `.github/renovate.json`
2. Create `CI_PAT` secret for release-please (personal access token with repo scope)
3. Configure GitHub Pages source to "GitHub Actions"
4. Test release flow with `release-test/v*` branch

## GitHub Repository Setup

### Required Secrets

| Secret | Description |
|--------|-------------|
| `CI_PAT` | Personal access token with `repo` scope for release-please to create PRs |

### GitHub Pages Configuration

1. Go to Settings â†’ Pages
2. Source: "GitHub Actions"
3. The website workflow will handle deployment

### Branch Protection (Optional)

For `main` branch:
- Require status checks: `lint`, `test`, `build`
- Require PR reviews before merging

### PR Labels for Automation

Create these labels in the repository:
- `automerge` - Enables auto-merge (squash) when all checks pass
- `autoupdate` - Keeps PR up-to-date with main branch

Renovate and release-please PRs can be configured to use these labels automatically.

## Files to Create

```
.github/
â”œâ”€â”€ renovate.json
â””â”€â”€ workflows/
    â”œâ”€â”€ auto-merge.yml
    â”œâ”€â”€ auto-update.yml
    â”œâ”€â”€ ci.yml
    â”œâ”€â”€ release-please.yml
    â”œâ”€â”€ release.yml
    â”œâ”€â”€ semantic-pr.yml
    â””â”€â”€ website.yml

.goreleaser.yml
release-please-config.json
.release-please-manifest.json

website/
â”œâ”€â”€ docusaurus.config.ts
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ sidebars.ts
â”œâ”€â”€ bun.lock
â”œâ”€â”€ static/
â”‚   â””â”€â”€ img/
â”‚       â””â”€â”€ favicon.ico
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ css/
â”‚   â”‚   â””â”€â”€ custom.css
â”‚   â””â”€â”€ pages/
â”‚       â””â”€â”€ index.tsx
â””â”€â”€ docs/
    â”œâ”€â”€ intro.md
    â””â”€â”€ ...
```

## Testing the Setup

### Test CI

```bash
# Create a test branch
git checkout -b test/ci-setup
git push origin test/ci-setup

# Create a PR to trigger CI
gh pr create --title "test: CI setup" --body "Testing CI workflows"
```

### Test Release (Dry Run)

```bash
# Create a test release branch
git checkout -b release-test/v0.0.1
git push origin release-test/v0.0.1

# Check Actions tab for snapshot release
```

### Test Website

```bash
# Build locally
cd website
bun install
bun run build
bun run serve
```

## Success Criteria

- [ ] CI runs lint, test, build on PRs
- [ ] PR title validation works
- [ ] Release-please creates release PRs
- [ ] GoReleaser builds multi-platform binaries
- [ ] Docker images are pushed to ghcr.io
- [ ] Website deploys to GitHub Pages
- [ ] Renovate creates dependency update PRs
- [ ] Auto-merge works for PRs with `automerge` label
- [ ] Auto-update keeps labeled PRs up-to-date with main
